#!/bin/bash

# 1. On se d√©place dans le dossier o√π se trouve le fichier .env
cd /home/gregb/nopasaran/infra || exit 1

# 2. On r√©cup√®re les variables (plus s√ªr avec des guillemets)
DB_USER=$(grep POSTGRES_USER .env | cut -d '=' -f2)
DB_NAME=$(grep POSTGRES_DB .env | cut -d '=' -f2)
TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)

# 3. Backup de la Base de Donn√©es
# Note: On utilise les variables d√©finies plus haut pour que la ligne soit lisible
echo "üì¶ Backup SQL..."
docker exec -t nopasaran-db-1 pg_dump -U "$DB_USER" -d "$DB_NAME" > "/home/gregb/nopasaran/backups/backup_$TIMESTAMP.sql"

# 4. Backup des M√©dias (Uploads)
echo "üóÇÔ∏è Backup M√©dias..."
tar -czvf "/home/gregb/nopasaran/backups/media_backup_$TIMESTAMP.tar.gz" -C /home/gregb/nopasaran/infra/data uploads

# 5. Envoi vers Google Drive (Rclone)
echo "‚òÅÔ∏è Envoi vers Google Drive..."
rclone copy /home/gregb/nopasaran/backups/ gdrive:nopasaran/backups --transfers=1

# 6. Nettoyage local (Optionnel : pour ne pas saturer le disque du VPS)
# Supprime les fichiers locaux de plus de 10 jours (puisqu'ils sont sur le Drive)
find /home/gregb/nopasaran/backups/ -type f -mtime +10 -delete

